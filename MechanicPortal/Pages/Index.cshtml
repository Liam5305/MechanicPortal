@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="text-center">
    <h1 class="display-4">Welcome Home</h1>
</div>

@section Styles {
    <style>
        .card-img img {
            position: absolute;
            top: 100px;
            left: 20px;
            width: 200px;
            height: auto;
                }
    </style>
}

<div class="container">
    <div class="card-img">
        <img src="@Url.Content("~/Images/MechanicPortalLogo.png")" alt="Logo" />
    </div>
</div>

<br />
<br />
<div class="fw-bold"style="text-decoration-line:underline">
    <h4>On this page, you will be shown important information.</h4>
</div>
<div class="text-left">
    <h6>As shown in the graphs below, you can briefly see what vehicles have a pending MOT and employees that have been added.
    </h6>
</div>

<!-- Chart section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="chart-container">
            <canvas id="employeeChart"></canvas>
        </div>
    </div>
    <div class="col-md-6">
        <div class="chart-container">
            <canvas id="vehicleChart"></canvas>
        </div>
    </div>
</div>

@* <div style="">
    <h4>Debug Info:</h4>
    <pre>Employee Data: @Model.EmployeeData</pre>
    <pre>Vehicle Data: @Model.VehicleData</pre>
</div> *@

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        console.log('Chart.js loaded:', !!window.Chart);

        var employeeData = @Html.Raw(Model.EmployeeData ?? "[]");
        var vehicleData = @Html.Raw(Model.VehicleData ?? "[]");

        console.log('Employee Data:', employeeData);
        console.log('Vehicle Data:', vehicleData);

        function groupCountries(data) {
            const ukCountries = ['Wales', 'Scotland', 'Ireland', 'England'];
            const africanCountries = ['Zimbabwe', 'Ghana', 'Nigeria', 'South Africa', 'Rwanda', 'Malawi', 'Mozambique', 'Zambia', 'Angola', 'Botswana'];

            let ukTotal = 0;
            let africaTotal = 0;

            let groupedData = data.reduce((acc, item) => {
                if (ukCountries.includes(item.Label)) {
                    ukTotal += item.Value;
                } else if (africanCountries.includes(item.Label)) {
                    africaTotal += item.Value;
                } else {
                    acc.push(item);
                }
                return acc;
            }, []);

            if (ukTotal > 0) {
                groupedData.push({ Label: 'UK', Value: ukTotal });
            }

            if (africaTotal > 0) {
                groupedData.push({ Label: 'Africa', Value: africaTotal });
            }

            return groupedData;
        }

        function createPieChart(elementId, data, title) {
            var ctx = document.getElementById(elementId);
            if (!ctx) {
                console.error('Cannot find element with id:', elementId);
                return;
            }
            if (!data || data.length === 0) {
                console.error('No data available for chart:', title);
                return;
            }

            // Group countries before creating the chart
            var groupedData = groupCountries(data);

            try {
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: groupedData.map(item => item.Label),
                        datasets: [{
                            data: groupedData.map(item => item.Value),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: title
                            }
                        }
                    }
                });
                console.log('Chart created successfully:', title);
            } catch (error) {
                console.error('Error creating chart:', title, error);
            }
        }

        createPieChart('employeeChart', employeeData, 'Users added to Portal');
        createPieChart('vehicleChart', vehicleData, 'Vehicles that need MOT');
    </script>
}